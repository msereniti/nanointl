{"version":3,"file":"nanointl-unplugin.js","sources":["../src/nanointl-unplugin.ts"],"sourcesContent":["import { createUnplugin, UnpluginInstance } from 'unplugin';\nimport fs from 'fs/promises';\nimport { resolve as resolvePath } from 'path';\n\ntype UserOptions = {\n  defaultLocale: string;\n  localesDir: string;\n};\n\nexport const unplugin: UnpluginInstance<UserOptions, false> = createUnplugin((options: UserOptions) => {\n  if (!options.localesDir) {\n    throw new Error(`[@nanointl/unplugin] \"localesDir\" is a required option`);\n  }\n  if (!options.defaultLocale) {\n    throw new Error(`[@nanointl/unplugin] \"defaultLocale\" is a required option`);\n  }\n  return {\n    name: '@nanointl/unplugin',\n    resolveInclude(id: string) {\n      return id === '@nanointl/unplugin/runtime';\n    },\n    resolveId(id) {\n      if (id !== '@nanointl/unplugin/runtime') return undefined;\n      return '@nanointl/unplugin/runtime';\n    },\n    loadInclude(id) {\n      if (id.includes('@nanointl/unplugin/dist/runtime.mjs')) return true;\n      if (id.includes('@nanointl/unplugin/dist/runtime.js')) return true;\n      if (id.includes('/nanointl-unplugin/dist/runtime.mjs')) return true;\n      if (id.includes('/nanointl-unplugin/dist/runtime.js')) return true;\n      if (id === '@nanointl/unplugin/runtime') return true;\n      return false;\n    },\n    async load() {\n      const initLocale = process.env.LOCALE ?? options.defaultLocale;\n      const localesList = await fs.readdir(options.localesDir);\n      if (!localesList.length) {\n        this.error(`No locales was found in ${options.localesDir}`);\n        return;\n      }\n      if (!localesList.includes(`${initLocale}.json`)) {\n        this.error(`Locale ${initLocale} (was searching for \"${`${initLocale}.json`}\") was not found in ${options.localesDir}`);\n        return;\n      }\n      for (const localeFileName of localesList) {\n        this.addWatchFile(resolvePath(options.localesDir, localeFileName));\n      }\n      const initMessagesFilePath = resolvePath(options.localesDir, `${initLocale}.json`);\n      const loadMessages = localesList.map((localeFileName) => {\n        const localeName = localeFileName.split('.').slice(0, -1).join('.');\n        const importPath = resolvePath(options.localesDir, localeFileName);\n\n        return `[${JSON.stringify(localeName)}]: () => import(${JSON.stringify(importPath)}).then(x => x.default)`;\n      });\n\n      return `\n        export const initLocale = ${JSON.stringify(initLocale)};\n        import _initMessages from ${JSON.stringify(initMessagesFilePath)};\n        export const initMessages = _initMessages;\n        export const loadMessages = { ${loadMessages.join(', ')} };\n      `;\n    },\n  };\n});\n\nexport const nanointlVitePlugin: UnpluginInstance<UserOptions, false>['vite'] = unplugin.vite;\nexport const nanointlRollupPlugin: UnpluginInstance<UserOptions, false>['rollup'] = unplugin.rollup;\nexport const nanointlWebpackPlugin: UnpluginInstance<UserOptions, false>['webpack'] = unplugin.webpack;\nexport const nanointlEsbuildPlugin: UnpluginInstance<UserOptions, false>['esbuild'] = unplugin.esbuild;\n"],"names":["unplugin","createUnplugin","options","localesDir","defaultLocale","Error","name","resolveInclude","id","resolveId","loadInclude","includes","load","this","initLocale","_process$env$LOCALE","process","env","LOCALE","Promise","resolve","fs","readdir","then","localesList","length","_this2","addWatchFile","resolvePath","initMessagesFilePath","loadMessages","map","localeFileName","localeName","split","slice","join","importPath","JSON","stringify","error","vite","nanointlRollupPlugin","rollup","nanointlWebpackPlugin","webpack","esbuild"],"mappings":"+QASaA,MAAiDC,EAAAA,eAAe,SAACC,GAC5E,IAAKA,EAAQC,WACX,MAAM,UACP,0DACD,IAAKD,EAAQE,cACX,UAAMC,MAAA,6DAER,MAAO,CACLC,KAAM,qBACNC,eAFK,SAEUC,GACb,MAAc,+BAALA,CACV,EACDC,UALK,SAKKD,GACR,GAAW,+BAAPA,EACJ,MAAO,4BACR,EACDE,YAAYF,SAAAA,GACV,SAAIA,EAAGG,SAAS,wCACZH,EAAGG,SAAS,uCACZH,EAAGG,SAAS,wCACZH,EAAGG,SAAS,uCACL,+BAAPH,EAEL,EACKI,KAjBD,WAAA,YAqBDC,KAHcC,EAAA,OAAAC,EAAGC,QAAQC,IAAIC,QAAfH,EAAyBb,EAAQE,cADzC,OAAAe,QAAAC,QAEkBC,UAAGC,QAAQpB,EAAQC,aAFrCoB,KAAA,SAEFC,GACN,GAAKA,EAAYC,OAAjB,CAIA,GAAKD,EAAYb,SAAYG,EAAxB,SAAL,CAIA,IAA6BU,MAAAA,2qBAAAA,CAAAA,kBAC3BE,EAAKC,aAAaC,EAAWR,QAAClB,EAAQC,qBAExC,IAA0B0B,EAAGD,EAAAA,QAAY1B,EAAQC,WAAeW,EAAhE,SACkBgB,EAAGN,EAAYO,IAAI,SAACC,GACpC,IAAgBC,EAAGD,EAAeE,MAAM,KAAKC,MAAM,GAAI,GAAGC,KAAK,KACzDC,EAAaT,EAAAA,QAAY1B,EAAQC,WAAY6B,GAEnD,MAAWM,IAAAA,KAAKC,UAAUN,GAA1B,mBAAwDK,KAAKC,UAAUF,GACxE,wBAAA,GAED,MAAA,uCAC8BC,KAAKC,UAAUzB,2CACfwB,KAAKC,UAAUV,GAF7C,gGAIkCC,EAAaM,KAAK,mBAhBnD,CAFCV,EAAKc,MAAgB1B,UAAAA,EAAqCA,wBAAAA,EAArCA,4BAA6EZ,EAAQC,WAF3G,MAFCuB,EAAKc,iCAAiCtC,EAAQC,WAJxC,GAjBL,oCA+CR,KAE+EH,EAASyC,KAC5EC,EAAuE1C,EAAS2C,OAC3DC,EAAoD5C,EAAS6C,sCACT7C,EAAS8C"}