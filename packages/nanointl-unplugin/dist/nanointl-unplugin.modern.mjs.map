{"version":3,"file":"nanointl-unplugin.modern.mjs","sources":["../src/nanointl-unplugin.ts"],"sourcesContent":["import { createUnplugin, UnpluginInstance } from 'unplugin';\nimport fs from 'fs/promises';\nimport { resolve as resolvePath } from 'path';\n\ntype UserOptions = {\n  defaultLocale: string;\n  localesDir: string;\n};\n\nexport const unplugin: UnpluginInstance<UserOptions, false> = createUnplugin((options: UserOptions) => {\n  if (!options.localesDir) {\n    throw new Error(`[@nanointl/unplugin] \"localesDir\" is a required option`);\n  }\n  if (!options.defaultLocale) {\n    throw new Error(`[@nanointl/unplugin] \"defaultLocale\" is a required option`);\n  }\n  return {\n    name: '@nanointl/unplugin',\n    resolveInclude(id: string) {\n      return id === '@nanointl/unplugin/runtime';\n    },\n    resolveId(id) {\n      if (id !== '@nanointl/unplugin/runtime') return undefined;\n      return '@nanointl/unplugin/runtime';\n    },\n    loadInclude(id) {\n      if (id.includes('@nanointl/unplugin/dist/runtime.mjs')) return true;\n      if (id.includes('@nanointl/unplugin/dist/runtime.js')) return true;\n      if (id.includes('/nanointl-unplugin/dist/runtime.mjs')) return true;\n      if (id.includes('/nanointl-unplugin/dist/runtime.js')) return true;\n      if (id === '@nanointl/unplugin/runtime') return true;\n      return false;\n    },\n    async load() {\n      const initLocale = process.env.LOCALE ?? options.defaultLocale;\n      const localesList = await fs.readdir(options.localesDir);\n      if (!localesList.length) {\n        this.error(`No locales was found in ${options.localesDir}`);\n        return;\n      }\n      if (!localesList.includes(`${initLocale}.json`)) {\n        this.error(`Locale ${initLocale} (was searching for \"${`${initLocale}.json`}\") was not found in ${options.localesDir}`);\n        return;\n      }\n      for (const localeFileName of localesList) {\n        this.addWatchFile(resolvePath(options.localesDir, localeFileName));\n      }\n      const initMessagesFilePath = resolvePath(options.localesDir, `${initLocale}.json`);\n      const loadMessages = localesList.map((localeFileName) => {\n        const localeName = localeFileName.split('.').slice(0, -1).join('.');\n        const importPath = resolvePath(options.localesDir, localeFileName);\n\n        return `[${JSON.stringify(localeName)}]: () => import(${JSON.stringify(importPath)}).then(x => x.default)`;\n      });\n\n      return `\n        export const initLocale = ${JSON.stringify(initLocale)};\n        import _initMessages from ${JSON.stringify(initMessagesFilePath)};\n        export const initMessages = _initMessages;\n        export const loadMessages = { ${loadMessages.join(', ')} };\n      `;\n    },\n  };\n});\n\nexport const nanointlVitePlugin: UnpluginInstance<UserOptions, false>['vite'] = unplugin.vite;\nexport const nanointlRollupPlugin: UnpluginInstance<UserOptions, false>['rollup'] = unplugin.rollup;\nexport const nanointlWebpackPlugin: UnpluginInstance<UserOptions, false>['webpack'] = unplugin.webpack;\nexport const nanointlEsbuildPlugin: UnpluginInstance<UserOptions, false>['esbuild'] = unplugin.esbuild;\n"],"names":["unplugin","createUnplugin","options","localesDir","Error","defaultLocale","name","resolveInclude","id","resolveId","loadInclude","includes","async","initLocale","process","env","LOCALE","localesList","fs","readdir","length","this","error","addWatchFile","resolvePath","localeFileName","initMessagesFilePath","loadMessages","map","localeName","split","slice","join","importPath","JSON","stringify","nanointlVitePlugin","vite","nanointlRollupPlugin","rollup","nanointlWebpackPlugin","webpack","nanointlEsbuildPlugin","esbuild"],"mappings":"oGASaA,MAAQA,EAAyCC,EAAgBC,IAC5E,IAAKA,EAAQC,WACX,MAAUC,IAAAA,MAAM,0DAElB,IAAKF,EAAQG,cACX,MAAM,IAAAD,MAAU,6DAElB,MAAO,CACLE,KAAM,qBACNC,eAAeC,GACC,iCAEhBC,UAAUD,GACR,GAAW,+BAAPA,EACJ,MAAO,4BACR,EACDE,YAAYF,MACNA,EAAGG,SAAS,wCACZH,EAAGG,SAAS,uCACZH,EAAGG,SAAS,wCACZH,EAAGG,SAAS,uCACL,+BAAPH,GAGNI,mBACE,MAAMC,EAAmCX,SAAtBY,QAAQC,IAAIC,QAAUd,EAAAA,EAAQG,cAC3CY,QAAoBC,EAAGC,QAAQjB,EAAQC,YAC7C,IAAKc,EAAYG,OAEf,YADAC,KAAKC,MAAM,2BAA2BpB,EAAQC,cAGhD,IAAKc,EAAYN,SAAY,GAAAE,UAE3B,YADAQ,KAAKC,MAAM,UAAUT,yBAAqCA,6BAAwCX,EAAQC,cAG5G,IAAK,WAAwBc,EAC3BI,KAAKE,aAAaC,EAAYtB,EAAQC,WAAYsB,IAEpD,MAA0BC,EAAGF,EAAYtB,EAAQC,WAAe,GAAAU,UAC1Dc,EAAeV,EAAYW,IAAKH,IACpC,MAAMI,EAAaJ,EAAeK,MAAM,KAAKC,MAAM,GAAI,GAAGC,KAAK,KACzDC,EAAaT,EAAYtB,EAAQC,WAAYsB,GAEnD,MAAW,IAAAS,KAAKC,UAAUN,qBAA8BK,KAAKC,UAAUF,6BAGzE,MAAO,uCACuBC,KAAKC,UAAUtB,0CACfqB,KAAKC,UAAUT,kGAEXC,EAAaK,KAAK,kBAErD,EA7CI,GAiDsBI,EAAiDpC,EAASqC,KACxDC,EAAmDtC,EAASuC,OAChFC,EAAyExC,EAASyC,QAClFC,EAAyE1C,EAAS2C"}